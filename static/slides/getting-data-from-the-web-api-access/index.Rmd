---
title: "Getting data from the web: API access"
author: "[MACS 30500](https://cfss.uchicago.edu) <br /> University of Chicago"
output: rcfss::xaringan
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
knitr::opts_chunk$set(cache = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      fig.retina = 2, fig.width = 12)

library(tidyverse)
library(broom)
library(jsonlite)
library(stringr)
library(XML)
library(curl)
library(repurrrsive)
library(listviewer)
library(wordcloud)
library(tidytext)
library(manifestoR)
library(httr)
library(rtweet)
library(viridis)

set.seed(1234)
theme_set(theme_minimal(base_size = rcfss::base_size))
```

# Methods for obtaining data online

* Click and download
* Install and play
* API query
* Scraping

---

# Click and download

* `read.csv` or `readr::read_csv`
* `downloader` package or `curl`

---

# Data supplied on the web

* Application programming interface (API)
* Client
* Server

---

# Install and play packages

* Packages with R functions written for existing APIs
* Useful because
    * reproducible
    * updating
    * ease
    * scaling

---

# `manifestoR`

* Collects and organizes political party manifestos from around the world
* Over 1000 parties from 1945 until today in over 50 countries on five continents
* [`manifestoR`](https://github.com/ManifestoProject/manifestoR)

---

# API authentication

* Key/token
* Obtain key
* Store in `.Rprofile`

```{r rprofile, eval = FALSE}
# in .Rprofile
options("this_is_my_key" = XXXX)

# later, in the R script:
key <- getOption("this_is_my_key")
```

---

# Load library and set API key

```{r manifestor-load, cache = FALSE}
library(manifestoR)

# retrieve API key stored in .Rprofile
mp_setapikey(key = getOption("manifesto_key"))
```

---

# Retrieve the database

```{r manifestor-db}
(mpds <- mp_maindataset())
```

---

```{r manifesto-dist, echo = FALSE}
mpds %>%
  filter(countryname == "Sweden") %>%
  count(partyname) %>%
  ggplot(aes(fct_reorder(partyname, n), n)) +
  geom_col() +
  labs(title = "Political manifestos published in Sweden",
       x = NULL,
       y = "Total (1948-present)") +
  coord_flip()
```

---

# Download manifestos

```{r manifestor-corpus, echo = FALSE, message = FALSE, warning = FALSE}
# download documents
docs <- mp_corpus(countryname == "United States" & edate > as.Date("2012-01-01"))

# generate wordcloud of most common terms
docs %>%
  tidy() %>%
  mutate(party = factor(party, levels = c(61320, 61620),
                        labels = c("Democratic Party", "Republican Party"))) %>%
  unnest_tokens(word, text) %>%
  anti_join(stop_words) %>%
  count(party, word, sort = TRUE) %>%
  drop_na() %>%
  reshape2::acast(word ~ party, value.var = "n", fill = 0) %>%
  comparison.cloud(max.words = 200)
```

---

# Census data with `tidycensus`

* API to access data from US Census Bureau
    * Decennial census
    * American Community Survey
* Returns tidy data frames with (optional) `sf` geometry
* Search for variables with `load_variables()`

---

# Store API key

```{r tidycensus}
library(tidycensus)
```

```r
census_api_key("YOUR API KEY GOES HERE")
```

---

# Obtain data

```{r income-usa}
usa_inc <- get_acs(geography = "state", 
                   variables = c(medincome = "B19013_001"), 
                   year = 2016)
usa_inc
```

---

# Visualize data

```{r income-usa-plot, echo = FALSE, fig.asp = .7}
usa_inc %>%
  ggplot(aes(x = reorder(NAME, estimate), y = estimate)) +
  geom_pointrange(aes(ymin = estimate - moe,
                     ymax = estimate + moe),
                  size = .25) +
  coord_flip() +
  labs(title = "Household income by state",
       subtitle = "2012-2016 American Community Survey",
       x = "",
       y = "ACS estimate (bars represent margin of error)") +
  theme_minimal(base_size = rcfss::base_size * 0.7)
```


---

# Twitter API

* REST API
* Streaming API

* [`twitteR`](https://cran.rstudio.com/web/packages/twitteR/index.html)
* [`streamR`](https://cran.rstudio.com/web/packages/streamR/index.html)
* [`rtweet`](http://rtweet.info/)

---

# Using `rtweet`

```{r twitter}
library(rtweet)
```

* Requires a Twitter account
* Prompt to authorize application on first usage

---


# Searching tweets

```{r twitter-rstats}
rt <- search_tweets(
  q = "#rstats",
  n = 3000,
  include_rts = FALSE
)
rt
```

---

# Searching users

```{r twitter-count}
countvoncount <- get_timeline(user = "countvoncount", n = 1000)
countvoncount
```

---

# Visualizing tweets

```{r rstats-freq}
ts_plot(rt, by = "3 hours")
```

---

# Visualizing tweets


```{r rstats-freq-day}
ts_plot(rt, by = "1 hours")
```

---

# Visualizing tweets

```{r rstats-freq-clean, fig.height = 3.5}
ts_plot(rt, by = "3 hours") +
  theme(plot.title = element_text(face = "bold")) +
  labs(
    x = NULL, y = NULL,
    title = "Frequency of #rstats Twitter statuses from past 9 days",
    subtitle = "Twitter status (tweet) counts aggregated using three-hour intervals",
    caption = "\nSource: Data collected from Twitter's REST API via rtweet"
  )
```

---

# Exercise: Practice using `rtweet`

.pull-left[

![](https://upload.wikimedia.org/wikipedia/commons/thumb/2/21/Katy_Perry%E2%80%93Zenith_Paris.jpg/360px-Katy_Perry%E2%80%93Zenith_Paris.jpg)

]

.pull-right[

![](https://upload.wikimedia.org/wikipedia/commons/thumb/d/df/Kim_Kardashian_West_2014.jpg/320px-Kim_Kardashian_West_2014.jpg)

]

---

# Writing an API function

* No package for API
* Write your own function!
* [Open Movie Database](http://www.omdbapi.com/)

---

# Determine the shape of an API request

![](/img/ombd.png)

---

# Determine the shape of an API request

```http
http://www.omdbapi.com/?apikey=[apikey]&t=Sharknado&y=2013&plot=short&r=xml
```

```http
<?xml version="1.0" encoding="UTF-8"?><root response="True"><movie title="Sharknado" year="2013" rated="TV-14" released="11 Jul 2013" runtime="86 min" genre="Comedy, Horror, Sci-Fi" director="Anthony C. Ferrante" writer="Thunder Levin" actors="Ian Ziering, Tara Reid, John Heard, Cassandra Scerbo" plot="When a freak hurricane swamps Los Angeles, nature's deadliest killer rules sea, land, and air as thousands of sharks terrorize the waterlogged populace." language="English" country="USA" awards="1 win &amp; 2 nominations." poster="https://images-na.ssl-images-amazon.com/images/M/MV5BOTE2OTk4MTQzNV5BMl5BanBnXkFtZTcwODUxOTM3OQ@@._V1_SX300.jpg" metascore="N/A" imdbRating="3.3" imdbVotes="38,948" imdbID="tt2724064" type="movie"/></root>
```

---

# Create a request in R

```{r omdb-key}
# retrieve API key from .RProfile
omdb_key <- getOption("omdb_key")
```

```{r omdb-function, dependson = "omdb-key"}
# function to create API request
omdb <- function(Key, Title, Year, Plot, Format){
  baseurl <- "http://www.omdbapi.com/?"
  params <- c("apikey=", "t=", "y=", "plot=", "r=")
  values <- c(Key, Title, Year, Plot, Format)
  param_values <- map2_chr(params, values, str_c)
  args <- str_c(param_values, collapse = "&")
  str_c(baseurl, args)
}

omdb(omdb_key, "Sharknado", "2013", "short", "xml")
```

---

# `httr`

* GET
* POST
* PUT
* DELETE

---

# `GET()` Sharknado

```{r httr-json}
sharknado_json <- omdb(omdb_key, "Sharknado", "2013", "short", "json")
response_json <- GET(sharknado_json)
content(response_json, as = "parsed", type = "application/json")
```

---

# JavaScript Object Notation (JSON)

```javascript
{
  "crust": "original",
  "toppings": ["cheese", "pepperoni", "garlic"],
  "status": "cooking",
  "customer": {
    "name": "Brian",
    "phone": "573-111-1111"
  }
}
```

---

# Headers

```{r httr-headers, dependson = "httr-json"}
headers(response_json)
```

---

# HTTP status code

```{r httr-status, dependson = "httr-json"}
status_code(response_json)
```

---

# HTTP status code

Code | Status
-------|--------|
1xx    | Informational
2xx    | Success
3xx    | Redirection
4xx    | Client error (you did something wrong)
5xx    | Server error (server did something wrong)

> [A more intuitive guide](https://www.flickr.com/photos/girliemac/sets/72157628409467125)

---

# Skip `omdb()`

```{r httr-get-only}
sharknado_2 <- GET("http://www.omdbapi.com/?",
                   query = list(t = "Sharknado 2: The Second One",
                                y = 2014,
                                plot = "short",
                                r = "json",
                                apikey = omdb_key))

content(sharknado_2)
```

---

# Messy API responses

```{r omdb-recursive, echo = FALSE, error = TRUE, warning = FALSE}
content(response_json, as = "parsed", type = "application/json") %>% 
  as_tibble()
```

---

# Whoops

```{r omdb-str, echo = FALSE}
content(response_json, as = "parsed", type = "application/json") %>%
  jsonedit(mode = "view", elementId = "sharknado")
```

---

# Rectangling and `tidyr`

* Art and craft of taking a deeply nested list and taming it into a tidy data set of rows and columns


* `unnest_longer()`
* `unnest_wider()`
* `unnest_auto()`
* `hoist()`
  
---

# `unnest_wider()` and `hoist()`

```{r gh-users}
str(gh_users, list.len = 3)
```

---

# `unnest_wider()` and `hoist()`

```{r gh-users-df}
(users <- tibble(user = gh_users))
```

--

```{r gh-users-names, dependson = "gh-users-df"}
names(users$user[[1]])
```

---

# `unnest_wider()`

```{r gh-users-unnest-wider, dependson = "gh-users-df"}
users %>%
  unnest_wider(user)
```

---

# `hoist()`

```{r gh-users-hoist, dependson = "gh-users-df"}
users %>%
  hoist(user, 
        followers = "followers", 
        login = "login", 
        url = "html_url"
  )
```

---

# `gh_repos` and nested list structures

```{r gh-repos}
(repos <- tibble(repo = gh_repos))
```

---

# `unnest_longer()`

```{r gh-repos-unnest-longer, dependson = "gh-repos"}
repos <- repos %>%
  unnest_longer(repo)
repos
```

---

# `unnest_longer()`

```{r gh-repos-hoist, dependson = "gh-repos-unnest-longer"}
repos %>%
  hoist(repo, 
        login = c("owner", "login"), 
        name = "name",
        homepage = "homepage",
        watchers = "watchers_count"
  )
```

---

# `unnest_auto()`

```{r gh-repos-auto, message = TRUE}
tibble(repo = gh_repos) %>% 
  unnest_auto(repo) %>% 
  unnest_auto(repo)
```

---

# ASOIAF characters

```{r got}
chars <- tibble(char = got_chars)
chars
```

---

# ASOIAF characters

```{r got-wider}
chars2 <- chars %>%
  unnest_wider(char)
chars2
```

---

# Nested list objects

```{r got-list-cols, dependson = "got-wider"}
chars2 %>%
  select_if(is.list)
```

---

# Choose your own adventure

.center[

![:scale 40%](https://images-na.ssl-images-amazon.com/images/I/81E88dflPeL.jpg)

]

---

# Every appearance per book/season

```{r got-appearances, dependson = "got-wider"}
chars2 %>% 
  select(name, books, tvSeries) %>% 
  pivot_longer(c(books, tvSeries), names_to = "media", values_to = "value") %>% 
  unnest_longer(value)
```

---

# Match title to name

```{r got-title-name, dependson = "got-wider"}
chars2 %>% 
  select(name, title = titles) %>% 
  unnest_longer(title)
```

---

# Practice rectangling

<div style="width:100%;height:0;padding-bottom:49%;position:relative;"><iframe src="https://giphy.com/embed/1l522MnWgimYM" width="100%" height="100%" style="position:absolute" frameBorder="0" class="giphy-embed" allowFullScreen></iframe></div>
